<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Room Layout Solver - Residential Apartment</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
        }
        .description {
            color: #666;
            margin-bottom: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-left: 4px solid #4ECDC4;
            border-radius: 4px;
        }
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        .input-panel {
            display: flex;
            flex-direction: column;
        }
        .input-panel h3 {
            margin-top: 0;
            color: #333;
        }
        #json-input {
            flex: 1;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 4px;
            resize: vertical;
            min-height: 500px;
            background: #f9f9f9;
        }
        #json-input:focus {
            outline: none;
            border-color: #4ECDC4;
            background: white;
        }
        .output-panel {
            display: flex;
            flex-direction: column;
        }
        .output-panel h3 {
            margin-top: 0;
            color: #333;
        }
        #canvas { 
            border: 2px solid #ccc; 
            display: block;
            background: white;
            border-radius: 4px;
        }
        .controls { 
            margin: 15px 0;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .boundary-inputs {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-left: auto;
        }
        .boundary-inputs label {
            font-size: 14px;
            color: #666;
        }
        .boundary-inputs input {
            width: 60px;
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        button {
            padding: 10px 20px;
            font-size: 14px;
            cursor: pointer;
            border: none;
            border-radius: 4px;
            background: #4ECDC4;
            color: white;
            transition: background 0.3s;
            font-weight: 600;
        }
        button:hover {
            background: #45B7D1;
        }
        button:active {
            transform: translateY(1px);
        }
        button.secondary {
            background: #95a5a6;
        }
        button.secondary:hover {
            background: #7f8c8d;
        }
        #stats {
            display: block;
            margin-top: 15px;
            padding: 10px;
            background: #e8f5e9;
            border-radius: 4px;
            font-weight: bold;
            font-size: 14px;
        }
        .error {
            color: #e74c3c;
            background: #ffebee;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            font-size: 13px;
        }
        .hint {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üè† Constraint-Based Room Layout Solver</h1>
        <div class="description">
            <strong>Instructions:</strong> Edit the JSON configuration on the left to define your rooms and constraints, 
            then click "Solve Layout" to generate an optimal floor plan. You can modify room sizes, adjacency requirements, 
            and other constraints.
        </div>
        
        <div class="main-grid">
            <!-- Left Panel: JSON Input -->
            <div class="input-panel">
                <h3>üìù Room Configuration (JSON)</h3>
                <textarea id="json-input" spellcheck="false"></textarea>
                <div class="hint">
                    Edit the JSON above to customize rooms, minimum areas, adjacency rules, and constraints.
                </div>
            </div>
            
            <!-- Right Panel: Visualization -->
            <div class="output-panel">
                <h3>üé® Generated Layout</h3>
                <div class="controls">
                    <button id="solve-btn">üîç Solve Layout</button>
                    <button id="clear-btn" class="secondary">üóëÔ∏è Clear</button>
                    <div class="boundary-inputs">
                        <label>Width (m):</label>
                        <input type="number" id="boundary-width" value="10" min="5" max="20" step="0.5">
                        <label>Height (m):</label>
                        <input type="number" id="boundary-height" value="8.5" min="5" max="20" step="0.5">
                    </div>
                </div>
                <canvas id="canvas" width="650" height="550"></canvas>
                <div id="stats"></div>
                <div id="error-msg" class="error" style="display: none;"></div>
            </div>
        </div>
    </div>
    
    <script type="module">
        // Use Web Worker for async solving
        let solverWorker = null;
        let currentSolveTimeout = null;
        
        async function run() {
            // Default example configuration
            const exampleRooms = [
                {
                    id: "master_bedroom",
                    min_area: 12.0,
                    adjacent_to: ["master_bathroom"],
                    not_adjacent_to: ["kitchen"],
                    has_exterior_wall: true
                },
                {
                    id: "bedroom_2",
                    min_area: 9.0,
                    adjacent_to: ["hallway"],
                    not_adjacent_to: ["kitchen"],
                    has_exterior_wall: true
                },
                {
                    id: "bedroom_3",
                    min_area: 9.0,
                    adjacent_to: ["hallway"],
                    not_adjacent_to: ["kitchen"],
                    has_exterior_wall: true
                },
                {
                    id: "living_room",
                    min_area: 20.0,
                    adjacent_to: ["kitchen"],
                    not_adjacent_to: [],
                    has_exterior_wall: true
                },
                {
                    id: "kitchen",
                    min_area: 8.0,
                    adjacent_to: ["living_room"],
                    not_adjacent_to: ["master_bedroom", "bedroom_2", "bedroom_3"],
                    has_exterior_wall: false
                },
                {
                    id: "main_bathroom",
                    min_area: 4.0,
                    adjacent_to: ["hallway"],
                    not_adjacent_to: [],
                    has_exterior_wall: true
                },
                {
                    id: "master_bathroom",
                    min_area: 4.0,
                    adjacent_to: ["master_bedroom"],
                    not_adjacent_to: [],
                    has_exterior_wall: true
                },
                {
                    id: "hallway",
                    min_area: 5.0,
                    adjacent_to: ["bedroom_2", "bedroom_3", "main_bathroom", "living_room"],
                    not_adjacent_to: [],
                    has_exterior_wall: false
                }
            ];
            
            // Load example JSON into textarea on page load
            const jsonInput = document.getElementById('json-input');
            jsonInput.value = JSON.stringify(exampleRooms, null, 2);
            
            document.getElementById('solve-btn').onclick = async () => {
                const statsEl = document.getElementById('stats');
                const errorEl = document.getElementById('error-msg');
                const solveBtn = document.getElementById('solve-btn');
                errorEl.style.display = 'none';
                
                try {
                    // Parse JSON input
                    const jsonText = document.getElementById('json-input').value;
                    const rooms = JSON.parse(jsonText);
                    
                    // Validate that rooms is an array
                    if (!Array.isArray(rooms)) {
                        throw new Error('JSON must be an array of room objects');
                    }
                    
                    // Get boundary dimensions
                    const boundaryWidth = parseFloat(document.getElementById('boundary-width').value);
                    const boundaryHeight = parseFloat(document.getElementById('boundary-height').value);
                    
                    // Start solving with Web Worker
                    await solveWithWorker(rooms, boundaryWidth, boundaryHeight, statsEl, errorEl, solveBtn);
                    
                } catch (e) {
                    console.error("Error:", e);
                    statsEl.style.display = 'none';
                    errorEl.style.display = 'block';
                    errorEl.innerHTML = `<strong>‚ùå Error:</strong> ${e.message || e}`;
                    solveBtn.disabled = false;
                    solveBtn.textContent = 'üîç Solve Layout';
                }
            };
            
            async function solveWithWorker(rooms, boundaryWidth, boundaryHeight, statsEl, errorEl, solveBtn) {
                // Terminate any existing worker
                if (solverWorker) {
                    solverWorker.terminate();
                    clearTimeout(currentSolveTimeout);
                }
                
                // Disable button during solving
                solveBtn.disabled = true;
                solveBtn.textContent = '‚è≥ Solving...';
                
                // Show progress message
                const complexWarning = rooms.length > 6 
                    ? '<br><small>Complex layout detected - this may take 10-30 seconds</small>'
                    : '';
                statsEl.innerHTML = '‚è≥ Solving asynchronously... ' + 
                    '<span id="timer">0s</span>' + complexWarning;
                statsEl.style.background = '#fff3cd';
                statsEl.style.display = 'block';
                
                // Start timer display
                const startTime = Date.now();
                const timerInterval = setInterval(() => {
                    const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
                    const timerEl = document.getElementById('timer');
                    if (timerEl) timerEl.textContent = elapsed + 's';
                }, 100);
                
                // Create new worker
                solverWorker = new Worker('./solver-worker.js', { type: 'module' });
                
                // Set up timeout (30 seconds)
                const TIMEOUT_MS = 300000;
                currentSolveTimeout = setTimeout(() => {
                    solverWorker.terminate();
                    clearInterval(timerInterval);
                    statsEl.style.display = 'none';
                    errorEl.style.display = 'block';
                    errorEl.innerHTML = 
                        '<strong>‚ùå Timeout:</strong> Solver took longer than 30 seconds.<br><br>' +
                        '<strong>üí° Suggestions:</strong><ul style="text-align: left; margin: 10px 0;">' +
                        '<li>Increase boundary dimensions (width/height)</li>' +
                        '<li>Reduce the number of rooms</li>' +
                        '<li>Simplify adjacency constraints</li>' +
                        '<li>Reduce minimum area requirements</li>' +
                        '</ul>';
                    solveBtn.disabled = false;
                    solveBtn.textContent = 'üîç Solve Layout';
                }, TIMEOUT_MS);
                
                // Handle worker response
                solverWorker.onmessage = function(e) {
                    clearTimeout(currentSolveTimeout);
                    clearInterval(timerInterval);
                    
                    if (e.data.success) {
                        const solution = e.data.solution;
                        const elapsed = e.data.elapsed;
                        
                        drawSolution(solution, boundaryWidth, boundaryHeight);
                        
                        statsEl.style.background = '#e8f5e9';
                        statsEl.innerHTML = 
                            `‚úÖ <strong>Solution Found!</strong><br>` +
                            `Score: ${solution.score.toFixed(2)} | ` +
                            `Time: ${elapsed}ms (${(elapsed/1000).toFixed(1)}s) | ` +
                            `Rooms: ${solution.rooms.length} | ` +
                            `Boundary: ${boundaryWidth}m √ó ${boundaryHeight}m (${(boundaryWidth * boundaryHeight).toFixed(1)}m¬≤)`;
                    } else {
                        statsEl.style.display = 'none';
                        errorEl.style.display = 'block';
                        
                        let errorMsg = e.data.error;
                        
                        // Provide helpful suggestions for common issues
                        if (errorMsg.includes('No valid solution')) {
                            errorMsg += '<br><br><strong>üí° Suggestions:</strong><ul style="text-align: left; margin: 10px 0;">' +
                                '<li>Increase boundary dimensions (width/height)</li>' +
                                '<li>Reduce the number of rooms</li>' +
                                '<li>Simplify adjacency constraints (fewer adjacent_to/not_adjacent_to)</li>' +
                                '<li>Reduce minimum area requirements</li>' +
                                '<li>Try removing has_exterior_wall requirements</li>' +
                                '</ul>';
                        }
                        
                        errorEl.innerHTML = `<strong>‚ùå Error:</strong> ${errorMsg}`;
                    }
                    
                    // Re-enable button
                    solveBtn.disabled = false;
                    solveBtn.textContent = 'üîç Solve Layout';
                    
                    // Clean up worker
                    solverWorker.terminate();
                    solverWorker = null;
                };
                
                // Handle worker errors
                solverWorker.onerror = function(error) {
                    clearTimeout(currentSolveTimeout);
                    clearInterval(timerInterval);
                    console.error("Worker error:", error);
                    statsEl.style.display = 'none';
                    errorEl.style.display = 'block';
                    errorEl.innerHTML = `<strong>‚ùå Worker Error:</strong> ${error.message}`;
                    solveBtn.disabled = false;
                    solveBtn.textContent = 'üîç Solve Layout';
                };
                
                // Send work to worker
                solverWorker.postMessage({
                    rooms: rooms,
                    boundaryWidth: boundaryWidth,
                    boundaryHeight: boundaryHeight
                });
            }
            
            document.getElementById('clear-btn').onclick = () => {
                const canvas = document.getElementById('canvas');
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                document.getElementById('stats').textContent = '';
                document.getElementById('stats').style.display = 'none';
                document.getElementById('error-msg').style.display = 'none';
            };
        }
        
        function drawSolution(solution, boundaryWidth, boundaryHeight) {
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Dynamic scale - fit to canvas with padding
            const padding = 50;
            const availableWidth = canvas.width - (padding * 2);
            const availableHeight = canvas.height - (padding * 2);
            
            const scaleX = availableWidth / boundaryWidth;
            const scaleY = availableHeight / boundaryHeight;
            const scale = Math.min(scaleX, scaleY); // Use smaller scale to fit both dimensions
            
            const offsetX = padding;
            const offsetY = padding;
            
            // Predefined room colors
            const roomColors = {
                'master_bedroom': '#FF6B6B',
                'bedroom_2': '#FFA07A',
                'bedroom_3': '#FFD93D',
                'living_room': '#4ECDC4',
                'kitchen': '#95E1D3',
                'main_bathroom': '#A8E6CF',
                'master_bathroom': '#C7CEEA',
                'hallway': '#E0E0E0'
            };
            
            // Color palette for unknown rooms
            const colorPalette = [
                '#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A',
                '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E2',
                '#95E1D3', '#A8E6CF', '#C7CEEA', '#FFD93D'
            ];
            
            // Function to get color for a room
            const getRoomColor = (roomId, index) => {
                return roomColors[roomId] || colorPalette[index % colorPalette.length];
            };
            
            // Draw each room
            solution.rooms.forEach((room, index) => {
                const x = room.x * scale + offsetX;
                const y = room.y * scale + offsetY;
                const width = room.width * scale;
                const height = room.height * scale;
                
                // Fill room with color
                ctx.fillStyle = getRoomColor(room.id, index);
                ctx.fillRect(x, y, width, height);
                
                // Draw border
                ctx.strokeStyle = '#333';
                ctx.lineWidth = 2;
                ctx.strokeRect(x, y, width, height);
                
                // Draw room label
                ctx.fillStyle = '#000';
                ctx.font = 'bold 12px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                
                // Format room name
                const roomName = room.id.split('_').map(word => 
                    word.charAt(0).toUpperCase() + word.slice(1)
                ).join(' ');
                
                // Calculate room area
                const area = (room.width * room.height).toFixed(1);
                
                // Draw room name
                ctx.fillText(roomName, x + width/2, y + height/2 - 8);
                
                // Draw area
                ctx.font = '11px Arial';
                ctx.fillStyle = '#555';
                ctx.fillText(`${area}m¬≤`, x + width/2, y + height/2 + 8);
            });
            
            // Draw building outline
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 4;
            ctx.strokeRect(offsetX, offsetY, boundaryWidth * scale, boundaryHeight * scale);
            
            // Reset text alignment
            ctx.textAlign = 'start';
            ctx.textBaseline = 'alphabetic';
        }
        
        run();
    </script>
</body>
</html>